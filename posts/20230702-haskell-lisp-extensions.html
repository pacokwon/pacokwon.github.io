<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width"/><title>하스켈로 간단한 Lisp 만들기 - 확장판</title><meta property="og:title" content="하스켈로 간단한 Lisp 만들기 - 확장판"/><meta property="og:site_name" content="Paco Kwon&#x27;s Blog"/><meta name="next-head-count" content="5"/><link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/atom-one-dark.min.css"/><link id="hljs-light" rel="alternative stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css" disabled=""/><link rel="shortcut icon" href="static/favicon-16x16.png"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/689295c571d1513e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/689295c571d1513e.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-97515393dccb2e54.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-d1728c3a778f1232.js" defer=""></script><script src="/_next/static/chunks/pages/_app-570540608ca7ace4.js" defer=""></script><script src="/_next/static/chunks/392-079b0eace61ca2f5.js" defer=""></script><script src="/_next/static/chunks/839-cea740531d2b3154.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-2df54bee87117d70.js" defer=""></script><script src="/_next/static/nGgP2WqrHtqA7AwY_62m_/_buildManifest.js" defer=""></script><script src="/_next/static/nGgP2WqrHtqA7AwY_62m_/_ssgManifest.js" defer=""></script><style data-emotion="css-global 12ldfex">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:#fff;font-family:'__Noto_Sans_KR_0298e2','__Noto_Sans_KR_Fallback_0298e2',Roboto;font-weight:400;font-size:1rem;line-height:1.5;background-color:#121212;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#121212;}*{padding:0;margin:0;}html{overflow-x:hidden;}body{overflow-x:hidden;position:relative;line-height:1.6;}:root{--fs-800:3rem;--fs-700:2rem;--fs-600:1.5rem;--fs-500:1.25rem;--fs-400:1.125rem;--fs-300:1rem;--fs-200:0.8rem;}</style><style data-emotion="css 670439 1lgdpai dy3din zjuml4 1ps3nxk vubbuv 6ipc24 mfiwgy 16as864 3iet4t 1qyknr9 bkna8o 1m2hk6l 400xyc 186wd1t 18ldivb 1pjtbja 1bas2qp 1jop5q6 v5nfi0 18bh6q1">.css-670439{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;overflow:visible;color:#fff;-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:inherit;}.css-670439::-moz-focus-inner{border-style:none;}.css-670439.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-670439{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-670439:hover{background-color:rgba(255, 255, 255, 0.08);}@media (hover: none){.css-670439:hover{background-color:transparent;}}.css-670439.Mui-disabled{background-color:transparent;color:rgba(255, 255, 255, 0.3);}.css-1lgdpai{background-color:#121212;color:#fff;-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12);background-image:linear-gradient(rgba(255, 255, 255, 0.09), rgba(255, 255, 255, 0.09));display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:static;}.css-1lgdpai.MuiAppBar-root{background-image:unset;}.css-1lgdpai.MuiAppBar-colorPrimary{box-shadow:none;background-color:#121212;color:#fff;}.css-dy3din{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;min-height:56px;}@media (min-width:0px){@media (orientation: landscape){.css-dy3din{min-height:48px;}}}@media (min-width:600px){.css-dy3din{min-height:64px;}}.css-dy3din.MuiToolbar-root{padding:0px 32px;}@media (max-width:599.95px){.css-dy3din.MuiToolbar-root{padding:0px 16px;}}@media (min-width:0px){.css-zjuml4{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media (min-width:600px){.css-zjuml4{display:none;}}.css-1ps3nxk{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;overflow:visible;color:#fff;-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:inherit;padding:12px;font-size:1.75rem;}.css-1ps3nxk::-moz-focus-inner{border-style:none;}.css-1ps3nxk.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-1ps3nxk{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-1ps3nxk:hover{background-color:rgba(255, 255, 255, 0.08);}@media (hover: none){.css-1ps3nxk:hover{background-color:transparent;}}.css-1ps3nxk.Mui-disabled{background-color:transparent;color:rgba(255, 255, 255, 0.3);}.css-vubbuv{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;}.css-6ipc24{margin:0;font-family:'__Noto_Sans_KR_0298e2','__Noto_Sans_KR_Fallback_0298e2',Roboto;font-weight:400;font-size:1.25rem;line-height:1.334;color:#90caf9;-webkit-text-decoration:none;text-decoration:none;}@media (min-width:600px){.css-6ipc24{font-size:1.3118rem;}}@media (min-width:960px){.css-6ipc24{font-size:1.4993rem;}}@media (min-width:1280px){.css-6ipc24{font-size:1.4993rem;}}.css-6ipc24:hover{-webkit-text-decoration:underline;text-decoration:underline;}@media (min-width:0px){.css-6ipc24{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;margin-left:16px;}}@media (min-width:600px){.css-6ipc24{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;margin-right:32px;}}.css-6ipc24.MuiLink-root,.css-6ipc24.MuiLink-underlineHover{color:#4db6ac;font-weight:700;}.css-mfiwgy{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}@media (min-width:0px){.css-mfiwgy{display:none;}}@media (min-width:600px){.css-mfiwgy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-16as864{margin:0;font-family:inherit;font-weight:inherit;font-size:inherit;line-height:inherit;letter-spacing:inherit;color:#90caf9;-webkit-text-decoration:underline;text-decoration:underline;text-decoration-color:rgba(144, 202, 249, 0.4);margin-right:16px;-webkit-text-decoration:none;text-decoration:none;color:#fff;}.css-16as864:hover{text-decoration-color:inherit;}.css-16as864:hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-3iet4t{margin:0;font-family:'__Noto_Sans_KR_0298e2','__Noto_Sans_KR_Fallback_0298e2',Roboto;font-weight:400;font-size:1rem;line-height:1.5;}.css-1qyknr9{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;display:block;padding-left:16px;padding-right:16px;}@media (min-width:600px){.css-1qyknr9{padding-left:24px;padding-right:24px;}}@media (min-width:960px){.css-1qyknr9{max-width:960px;}}@media (max-width:599.95px){.css-1qyknr9.MuiContainer-root{padding:0px;}}.css-bkna8o{background-color:#121212;color:#fff;-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:none;background-image:linear-gradient(rgba(255, 255, 255, 0), rgba(255, 255, 255, 0));padding:16px 40px 32px;}@media (max-width:599.95px){.css-bkna8o{padding:8px 16px 32px;}}.css-1m2hk6l h1,.css-1m2hk6l h2,.css-1m2hk6l h3{margin-top:32px;margin-bottom:8px;}.css-1m2hk6l p{margin-bottom:12px;font-size:var(--fs-300);}.css-1m2hk6l li{list-style-position:inside;}.css-1m2hk6l ul{padding-left:16px;}.css-1m2hk6l blockquote{border-left-width:1px;border-left-style:solid;border-left-color:#26a69a;padding-left:16px;font-style:italic;}.css-400xyc{font-weight:bold;margin-bottom:16px;}.css-186wd1t{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;gap:8px;margin-bottom:16px;}.css-18ldivb{max-width:100%;font-family:'__Noto_Sans_KR_0298e2','__Noto_Sans_KR_Fallback_0298e2',Roboto;font-size:0.8125rem;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;height:24px;color:rgba(0, 0, 0, 0.87);background-color:#90caf9;border-radius:16px;white-space:nowrap;-webkit-transition:background-color 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;cursor:default;outline:0;-webkit-text-decoration:none;text-decoration:none;border:0;padding:0;vertical-align:middle;box-sizing:border-box;}.css-18ldivb.Mui-disabled{opacity:0.38;pointer-events:none;}.css-18ldivb .MuiChip-avatar{margin-left:5px;margin-right:-6px;width:24px;height:24px;color:#e0e0e0;font-size:0.75rem;}.css-18ldivb .MuiChip-avatarColorPrimary{color:rgba(0, 0, 0, 0.87);background-color:#42a5f5;}.css-18ldivb .MuiChip-avatarColorSecondary{color:rgba(0, 0, 0, 0.87);background-color:#ab47bc;}.css-18ldivb .MuiChip-avatarSmall{margin-left:4px;margin-right:-4px;width:18px;height:18px;font-size:0.625rem;}.css-18ldivb .MuiChip-icon{margin-left:4px;margin-right:-4px;font-size:18px;color:inherit;}.css-18ldivb .MuiChip-deleteIcon{-webkit-tap-highlight-color:transparent;color:rgba(0, 0, 0, 0.7);font-size:16px;cursor:pointer;margin:0 5px 0 -6px;margin-right:4px;margin-left:-4px;}.css-18ldivb .MuiChip-deleteIcon:hover{color:rgba(255, 255, 255, 0.4);}.css-18ldivb .MuiChip-deleteIcon:hover,.css-18ldivb .MuiChip-deleteIcon:active{color:rgba(0, 0, 0, 0.87);}.css-18ldivb.MuiChip-colorPrimary{color:white;background:#009688;font-weight:500;}.css-1pjtbja{overflow:hidden;text-overflow:ellipsis;padding-left:8px;padding-right:8px;white-space:nowrap;}.css-1bas2qp{color:#4db6ac;-webkit-text-decoration:unset;text-decoration:unset;}.css-1bas2qp:hover{cursor:pointer;color:#80cbc4;font-weight:500;}.css-1jop5q6{border-radius:8px;font-weight:400;margin-bottom:12px;border:1px solid #212121;position:relative;}.css-1jop5q6 button{position:absolute;top:5px;right:5px;}.css-1jop5q6 code.hljs{background:var(--background-color);}.css-v5nfi0{color:#26a69a;background:#212121;border-radius:4px;font-weight:bold;}.css-18bh6q1{padding:24px 40px;}@media (max-width:599.95px){.css-18bh6q1{padding:24px 16px;}}.css-18bh6q1 .utterances{position:relative;box-sizing:border-box;width:100%;max-width:unset;margin:0;}</style><style data-href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fBBc-.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxM.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fBBc-.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfBBc-.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fCRc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fABc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fCBc4AMP6lbBP.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fBxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fCxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fChc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fBBc4AMP6lQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu72xKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu5mxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu7mxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4WxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu7WxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu7GxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxKKTU1Kg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fCRc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fABc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fCBc4AMP6lbBP.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fBxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fCxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fChc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fBBc4AMP6lQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfCRc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfABc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfCBc4AMP6lbBP.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfBxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfCxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfChc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfBBc4AMP6lQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic css-1lgdpai"><div class="MuiToolbar-root MuiToolbar-regular css-dy3din"><div class="MuiBox-root css-zjuml4"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorInherit MuiIconButton-sizeLarge css-1ps3nxk" tabindex="0" type="button" aria-label="account of current user" aria-controls="menu-appbar" aria-haspopup="true"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="MenuIcon"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button></div><a class="MuiTypography-root MuiTypography-h5 MuiLink-root MuiLink-underlineHover css-6ipc24" href="/">Paco Kwon</a><div class="MuiBox-root css-mfiwgy"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways css-16as864" href="/bio"><p class="MuiTypography-root MuiTypography-body1 css-3iet4t">Bio</p></a><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways css-16as864" href="/posts"><p class="MuiTypography-root MuiTypography-body1 css-3iet4t">Posts</p></a><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways css-16as864" href="/links"><p class="MuiTypography-root MuiTypography-body1 css-3iet4t">Links</p></a></div><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorInherit MuiIconButton-sizeMedium css-670439" tabindex="0" type="button"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="Brightness7Icon"><path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"></path></svg></button></div></header><main><div class="MuiContainer-root MuiContainer-maxWidthMd css-1qyknr9"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation0 css-bkna8o"><div class="css-1m2hk6l"><h1>하스켈로 간단한 Lisp 만들기 - 확장판</h1><div class="css-400xyc">2023-07-02</div><div class="css-186wd1t"><div class="MuiChip-root MuiChip-filled MuiChip-sizeSmall MuiChip-colorPrimary MuiChip-filledPrimary css-18ldivb"><span class="MuiChip-label MuiChip-labelSmall css-1pjtbja">ko</span></div><div class="MuiChip-root MuiChip-filled MuiChip-sizeSmall MuiChip-colorPrimary MuiChip-filledPrimary css-18ldivb"><span class="MuiChip-label MuiChip-labelSmall css-1pjtbja">haskell</span></div></div><div><p>하스켈로 LISP 만들기의 <a href="20230616-haskell-lisp-parsing" class="css-1bas2qp">첫 번째</a>와 <a href="20230618-lisp-eval" class="css-1bas2qp">두 번째</a> 포스트에서는 Lisp S-Expression의 파싱, 평가 방식을 간단하게 알아보았다. 너무도 간단해서 사실상 할 수 있는 것은 표현식 평가가 전부였다.</p>
<p>그 이후로 다양한 기능들을 추가해 토이 인터프리터를 확장해보았다. 아래 코드는 확장한 Lisp의 기능을 활용하여 작성할 수 있는 프로그램이다.</p>
<pre><div class="css-1jop5q6"><code class="hljs language-lisp">(<span class="hljs-name">define</span> (<span class="hljs-name">is-prime-helper</span> n x)
  (<span class="hljs-name">if</span> (<span class="hljs-name">&lt;</span> n (<span class="hljs-name">*</span> x x))
      true
      (<span class="hljs-name">if</span> (<span class="hljs-name">=</span> <span class="hljs-number">0</span> (% n x))
          false
          (<span class="hljs-name">is-prime-helper</span> n (<span class="hljs-name">+</span> <span class="hljs-number">1</span> x)))))

(<span class="hljs-name">define</span> (<span class="hljs-name">is-prime</span> n)
  (<span class="hljs-name">if</span> (<span class="hljs-name">&lt;</span> n <span class="hljs-number">2</span>)
      false
      (<span class="hljs-name">is-prime-helper</span> n <span class="hljs-number">2</span>)))

(<span class="hljs-name">is-prime</span> <span class="hljs-number">479001599</span>)
</code></div></pre>
<p>이 포스트에서는 이전 포스트들처럼 언어를 확장하는 과정을 처음부터 끝까지 소개하기보다는, 어떤 기능들이 추가되었는지, 구현하며 내부적으로 어떤 부분이 흥미로웠는지 소개하겠다.</p>
<h2 id="파일-단위-실행">파일 단위 실행</h2>
<p><a href="20230618-lisp-eval" class="css-1bas2qp">2부 - 평가</a> 포스트에서 코드를 직접 실행할 수 있는 REPL을 만들어 인터프리터의 엔트리포인트로 만들었었다. 확장한 이후에는 <code class="css-v5nfi0">python</code>처럼 REPL을 실행할수도, 파일을 실행할수도 있다.</p>
<p>이와 같은 <code class="css-v5nfi0">test.lisp</code> 파일이 있다고 가정했을 때:</p>
<pre><div class="css-1jop5q6"><code class="hljs language-lisp">(<span class="hljs-name">+</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span>)
(<span class="hljs-name">*</span> <span class="hljs-number">2</span> <span class="hljs-number">4</span> <span class="hljs-number">6</span>)
</code></div></pre>
<p>이 파일을 인자로 인터프리터에 넘기면 각각의 평가된 값이 출력된다.</p>
<pre><div class="css-1jop5q6"><code class="hljs language-bash">$ stack run whisper-exe test.lisp
6
48
</code></div></pre>
<p>파일명 이전에 <code class="css-v5nfi0">-i</code> 플래그를 넘기면, 파일을 실행한 이후의 상태를 그대로 물려받은 REPL을 실행할 수 있다.</p>
<p>이번에는 이와 같은 <code class="css-v5nfi0">test.lisp</code>가 있을 때:</p>
<pre><div class="css-1jop5q6"><code class="hljs language-lisp">(<span class="hljs-name">define</span> (<span class="hljs-name">add-two</span> a b) (<span class="hljs-name">+</span> a b))
</code></div></pre>
<p><code class="css-v5nfi0">-i</code> 플래그를 넘겨 실행해보면, <code class="css-v5nfi0">add-two</code> 함수가 그대로 접근 가능하다.</p>
<pre><div class="css-1jop5q6"><code class="hljs language-bash">$ stack run whisper-exe -- -i examples/def.lisp

&gt;&gt; (add-two 1 2)
3
&gt;&gt; add-two
&lt;<span class="hljs-keyword">function</span>&gt;
</code></div></pre>
<p>이 기능은 Lisp 코드를 수정하지 않고 여러 값을 넣어 함수 호출을 해보고 싶을 때 유용하다.</p>
<h2 id="boolean과-조건-표현식"><code class="css-v5nfi0">Boolean</code>과 조건 표현식</h2>
<p><code class="css-v5nfi0">if</code> 함수를 이용해 조건 분기를 할 수 있다. 이를 위해 <code class="css-v5nfi0">boolean</code>타입의 값과 표현식을 추가했다.</p>
<pre><div class="css-1jop5q6"><code class="hljs language-bash">&gt;&gt; <span class="hljs-literal">true</span>
<span class="hljs-literal">true</span>
&gt;&gt; <span class="hljs-literal">false</span>
<span class="hljs-literal">false</span>
&gt;&gt; (<span class="hljs-keyword">if</span> <span class="hljs-literal">true</span> 3 5)
3
&gt;&gt; (<span class="hljs-keyword">if</span> <span class="hljs-literal">false</span> 3 5)
5
</code></div></pre>
<h2 id="다양한-네이티브-함수">다양한 네이티브 함수</h2>
<p>기존에 있던 산술연산자 외에 비교연산자와 논리연산자를 구현했다.</p>
<pre><div class="css-1jop5q6"><code class="hljs language-bash">&gt;&gt; (&lt; 3 5)
True
&gt;&gt; (= 3 5)
False
&gt;&gt; (~ <span class="hljs-literal">true</span>)
False
&gt;&gt; (|| <span class="hljs-literal">true</span> <span class="hljs-literal">true</span> <span class="hljs-literal">false</span>)
True
&gt;&gt; (&amp;&amp; <span class="hljs-literal">false</span> <span class="hljs-literal">false</span> <span class="hljs-literal">true</span>)
False
&gt;&gt; (% 5 3)
2
&gt;&gt; (/ 5 3)
1
&gt;&gt; (<span class="hljs-keyword">if</span> (&lt; 3 5) 3 5)
3
</code></div></pre>
<h2 id="define을-이용한-전역변수-및-사용자-정의-함수-선언"><code class="css-v5nfi0">define</code>을 이용한 전역변수 및 사용자 정의 함수 선언</h2>
<p><code class="css-v5nfi0">define</code> 함수를 이용하면 다음과 같이 변수를 사용할 수 있다.</p>
<pre><div class="css-1jop5q6"><code class="hljs language-lisp">(<span class="hljs-name">define</span> global <span class="hljs-number">3</span>)

global            <span class="hljs-comment">; 3</span>
(<span class="hljs-name">+</span> global global) <span class="hljs-comment">; 6</span>
</code></div></pre>
<p>첫번째 인자가 괄호에 감싸져 있다면 함수가 된다.</p>
<pre><div class="css-1jop5q6"><code class="hljs language-lisp">(<span class="hljs-name">define</span> (<span class="hljs-name">add-two</span> a b) (<span class="hljs-name">+</span> a b))

(<span class="hljs-name">add-two</span> <span class="hljs-number">42</span> <span class="hljs-number">3</span>)    <span class="hljs-comment">; 45</span>
</code></div></pre>
<h2 id="재귀함수-지원">재귀함수 지원</h2>
<p>이 언어에는 반복문이 없다.</p>
<p>하지만 괜찮다. 진정한 상남자 프로그래머는 반복문을 사용하지 않는다. 재귀를 사용한다!</p>
<pre><div class="css-1jop5q6"><code class="hljs language-lisp">(<span class="hljs-name">define</span> (<span class="hljs-name">add-range-helper</span> start end acc)
        (<span class="hljs-name">if</span> (<span class="hljs-name">&lt;</span> end start)
            acc
            (<span class="hljs-name">add-range-helper</span> (<span class="hljs-name">+</span> <span class="hljs-number">1</span> start) end (<span class="hljs-name">+</span> start acc))))

(<span class="hljs-name">define</span> (<span class="hljs-name">add-range</span> start end)
  (<span class="hljs-name">add-range-helper</span> start end <span class="hljs-number">0</span>))

(<span class="hljs-name">add-range</span> <span class="hljs-number">1</span> <span class="hljs-number">10</span>) <span class="hljs-comment">; 55</span>
</code></div></pre>
<h2 id="functions-as-values">Functions as Values</h2>
<p>네이티브 함수와 사용자 정의 함수는 값으로 취급되어 다음과 같이 다른 함수의 인자에 전달할 수도 있다.</p>
<pre><div class="css-1jop5q6"><code class="hljs language-lisp">(<span class="hljs-name">define</span> (<span class="hljs-name">apply-f-to-x</span> f x) (<span class="hljs-name">f</span> x))

(<span class="hljs-name">define</span> (<span class="hljs-name">times-two</span> x) (<span class="hljs-name">*</span> x <span class="hljs-number">2</span>))
(<span class="hljs-name">define</span> (<span class="hljs-name">add-two</span> x) (<span class="hljs-name">+</span> x <span class="hljs-number">2</span>))

(<span class="hljs-name">apply-f-to-x</span> times-two <span class="hljs-number">3</span>) <span class="hljs-comment">; 6</span>
(<span class="hljs-name">apply-f-to-x</span> add-two <span class="hljs-number">3</span>)   <span class="hljs-comment">; 5</span>
</code></div></pre>
<h2 id="statet와-either-타입을-이용한-환경-조작-및-에러-처리"><code class="css-v5nfi0">StateT</code>와 <code class="css-v5nfi0">Either</code> 타입을 이용한 환경 조작 및 에러 처리</h2>
<p>이번 프로젝트를 하며 가장 큰 의의는 모나드 트랜스포머(monad transformer)를 실제로 사용해봤다는 것이다. 기존에는 환경(Environment)를 <code class="css-v5nfi0">State</code> 모나드로 처리하고 있었다. 표현식을 평가하는 함수라면 항상 환경을 필요로 할 것이었고, 새로운 바인딩이 추가되면 환경을 수정해야 했기 때문이었다.</p>
<p>이를 <code class="css-v5nfi0">StateT</code>로 바꿔야겠다고 생각했던 이유는 에러처리 때문이었다. 기존에는 에러처리를 하스켈의 <code class="css-v5nfi0">error</code> 함수로 했었다. 이 때문에 <code class="css-v5nfi0">error</code> 함수가 있는 경로로 코드가 실행되면 그냥 프로그램이 죽어버렸다. 이를 처리하기 위해 평가 결과 타입을 단순히 <code class="css-v5nfi0">Value</code>를 사용하기보다 <code class="css-v5nfi0">Either String Value</code>를 사용하면 되겠다고 생각을 했다. 그러려면 <code class="css-v5nfi0">State</code> 모나드의 타입이 대략 이렇게 생겨야 한다:</p>
<pre><div class="css-1jop5q6"><code class="hljs language-haskell"><span class="hljs-class"><span class="hljs-keyword">newtype</span> <span class="hljs-type">State</span> s a = <span class="hljs-type">State</span> { <span class="hljs-title">runState</span> :: <span class="hljs-title">s</span> -&gt; <span class="hljs-type">Either</span> <span class="hljs-type">String</span> (<span class="hljs-title">a</span>, <span class="hljs-title">s</span>) }</span>
</code></div></pre>
<p>참고로 원래 <code class="css-v5nfi0">State</code> 타입은 이렇게 생겼다.</p>
<pre><div class="css-1jop5q6"><code class="hljs language-haskell"><span class="hljs-class"><span class="hljs-keyword">newtype</span> <span class="hljs-type">State</span> s a = <span class="hljs-type">State</span> { <span class="hljs-title">runState</span> :: <span class="hljs-title">s</span> -&gt; (<span class="hljs-title">a</span>, <span class="hljs-title">s</span>) }</span>
</code></div></pre>
<p>근데 <code class="css-v5nfi0">s</code>, <code class="css-v5nfi0">a</code>를 적당히 조작하는 것으로는 위쪽에 있는 타입은 만들 수 없다. 여기서 <a href="https://hackage.haskell.org/package/mtl-2.3.1/docs/Control-Monad-State-Lazy.html#t:StateT" class="css-1bas2qp"><code class="css-v5nfi0">StateT</code></a>가 등장한다.</p>
<pre><div class="css-1jop5q6"><code class="hljs language-haskell"><span class="hljs-class"><span class="hljs-keyword">newtype</span> <span class="hljs-type">StateT</span> s (<span class="hljs-title">m</span> :: <span class="hljs-type">Type</span> -&gt; <span class="hljs-type">Type</span>) a = <span class="hljs-type">State</span> { <span class="hljs-title">runState</span> :: <span class="hljs-title">s</span> -&gt; <span class="hljs-title">m</span> (<span class="hljs-title">a</span>, <span class="hljs-title">s</span>) }</span>
</code></div></pre>
<p>이를 <code class="css-v5nfi0">StateT Env (Either String) a</code>와 같이 사용하면 필요했던 타입을 만들 수 있고, 모나드 조작도 간편하게 할 수 있다. 아래는 scope-local 변수를 제공하는 <code class="css-v5nfi0">let</code> 함수의 코어 부분을 구현하는 <code class="css-v5nfi0">applyLet</code> 함수의 모습이다.</p>
<pre><div class="css-1jop5q6"><code class="hljs language-haskell"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">ExecState</span> = <span class="hljs-type">StateT</span> <span class="hljs-type">Env</span> (<span class="hljs-type">Either</span> <span class="hljs-type">String</span>)</span>

<span class="hljs-title">applyLet</span> :: [<span class="hljs-type">Sexpr</span>] -&gt; <span class="hljs-type">ExecState</span> <span class="hljs-type">Value</span>
<span class="hljs-title">applyLet</span> [decls, expr] = <span class="hljs-keyword">do</span>
  ogEnv &lt;- get
  extendWithDecls decls
  val &lt;- evalSexpr expr
  put ogEnv
  return val
<span class="hljs-title">applyLet</span> _ = lift . <span class="hljs-type">Left</span> $ <span class="hljs-string">&quot;Let construct must include two elements. A declaration and an expression!&quot;</span>

<span class="hljs-title">extendWithDecls</span> :: <span class="hljs-type">Sexpr</span> -&gt; <span class="hljs-type">ExecState</span> ()
<span class="hljs-comment">-- ...</span>
</code></div></pre>
<p>구현부를 보면 일반 <code class="css-v5nfi0">State</code> 모나드처럼 <code class="css-v5nfi0">get</code>을 통해 상태를 접근하는 것을 확인할 수 있다. <code class="css-v5nfi0">Either String</code> 타입으로 감싸져 있지만 말이다. <code class="css-v5nfi0">ogEnv</code>와 <code class="css-v5nfi0">val</code>은 원래와 같이 각각 <code class="css-v5nfi0">Env</code>, <code class="css-v5nfi0">Value</code> 타입이다. 마지막에 <code class="css-v5nfi0">return</code>을 하면 <code class="css-v5nfi0">Right</code>에 감싸져서 돌려준다.</p>
<p>반면 유효하지 않은 인자들의 경우 에러를 발생시키고 싶을 것이다. <code class="css-v5nfi0">applyLet _</code>의 구현부는, <code class="css-v5nfi0">Left</code>를 이용해 만든 <code class="css-v5nfi0">Either String Value</code> 타입을 <code class="css-v5nfi0">StateT</code> 타입의 값으로 변환시켜준다. <code class="css-v5nfi0">lift</code>만 사용하면 자동으로 <code class="css-v5nfi0">StateT</code>의 값으로 승격되며, 이 개념은 어떤 transformer를 사용해도 동일하게 적용할 수 있다.</p>
<p>이걸 처음 도입하려고 하면서 꽤나 머릿속이 복잡했었는데, 그래도 조금씩 이해하며 그 가치를 느낄 수 있었다. 사실 아직은 조금 마법같다. 아래는 이에 대한 <a href="https://wiki.haskell.org/Monad_Transformers_Explained" class="css-1bas2qp">하스켈 위키</a>의 설명 중 하나다:</p>
<blockquote>
<p>Monad transformers are like onions. At first, they make you cry but then you learn to appreciate them. Like onions, they&#x27;re also made of layers. Each layer is the functionality of a new monad, you lift monadic functions to get into the inner monads and you have transformerised functions to unwrap each layer.</p>
</blockquote>
<p>모나드 트랜스포머를 처음 봐도 눈물을 터뜨리지 않도록 조심하자.</p>
<h2 id="마무리">마무리</h2>
<p>비교적 간단한 프로젝트였지만 꽤 의미있는 경험이었다. 하스켈 코드를 작성하면서 느낀 것이지만 컴파일러를 잘 달래주면 많은 양의 버그가 사라지는 것 같다. 기억에 남는 버그는 함수 호출 시 환경을 병합할 때 <code class="css-v5nfi0">Map.union t1 t2</code>의 암묵적인 우선순위를 인지하지 못하고 그냥 사용해버려서 인자가 제대로 안 넘어가는 경우였는데, 하스켈에서 <code class="css-v5nfi0">trace</code>, <code class="css-v5nfi0">traceM</code> 등 순수 함수 안에서도 로그를 찍을 수 있는 짱짱한 도구들이 있어 잘 해결할 수 있었다.</p>
<p>또 하스켈이 이론적인 기반이 탄탄하다 보니 다양한 패턴들에 대한 내장 함수들이 많은 듯했다. 나름 내 아이디어로 내가 알고 있는 함수들을 이렇게 저렇게 조합하고 나니, hls(haskell language server)가 처음 들어보는 내장함수를 내밀며 &quot;이 함수 하나를 써서 네가 방금 쓴 엉망 코드를 리팩토링하지 않겠니?&quot;라는 제안을 받아본 것이 꽤 여러번이다.</p>
<p>마지막으로, 나는 이 포스트에 있는 기능을 추가하는 모든 과정을 영상에 담았다. 편집을 안한 정말 날것이라 다시 돌려볼 가치는 크게 없겠으나 녹화를 하며 코딩을 하니 감회가 달랐다. 어디 내놓기 부끄럽지만 유튜브에 <a href="https://www.youtube.com/playlist?list=PLZlApiQaKgfRrWRgC7Vaqck1VW5x6zHWS" class="css-1bas2qp">플레이리스트</a>를 만들어 두었다. 지금은 부끄럽기 짝이 없지만 나중에 돌려보며 웃을 수 있는 영상이 되었으면 좋겠다.</p></div></div></div><div id="utterances-comments" class="css-18bh6q1"></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":"20230702-haskell-lisp-extensions","content":"\n하스켈로 LISP 만들기의 [첫 번째](20230616-haskell-lisp-parsing)와 [두 번째](20230618-lisp-eval) 포스트에서는 Lisp S-Expression의 파싱, 평가 방식을 간단하게 알아보았다. 너무도 간단해서 사실상 할 수 있는 것은 표현식 평가가 전부였다.\n\n그 이후로 다양한 기능들을 추가해 토이 인터프리터를 확장해보았다. 아래 코드는 확장한 Lisp의 기능을 활용하여 작성할 수 있는 프로그램이다.\n\n```lisp\n(define (is-prime-helper n x)\n  (if (\u003c n (* x x))\n      true\n      (if (= 0 (% n x))\n          false\n          (is-prime-helper n (+ 1 x)))))\n\n(define (is-prime n)\n  (if (\u003c n 2)\n      false\n      (is-prime-helper n 2)))\n\n(is-prime 479001599)\n```\n\n이 포스트에서는 이전 포스트들처럼 언어를 확장하는 과정을 처음부터 끝까지 소개하기보다는, 어떤 기능들이 추가되었는지, 구현하며 내부적으로 어떤 부분이 흥미로웠는지 소개하겠다.\n\n## 파일 단위 실행\n\n[2부 - 평가](20230618-lisp-eval) 포스트에서 코드를 직접 실행할 수 있는 REPL을 만들어 인터프리터의 엔트리포인트로 만들었었다. 확장한 이후에는 `python`처럼 REPL을 실행할수도, 파일을 실행할수도 있다.\n\n이와 같은 `test.lisp` 파일이 있다고 가정했을 때:\n\n```lisp\n(+ 1 2 3)\n(* 2 4 6)\n```\n\n이 파일을 인자로 인터프리터에 넘기면 각각의 평가된 값이 출력된다.\n\n```bash\n$ stack run whisper-exe test.lisp\n6\n48\n```\n\n파일명 이전에 `-i` 플래그를 넘기면, 파일을 실행한 이후의 상태를 그대로 물려받은 REPL을 실행할 수 있다.\n\n이번에는 이와 같은 `test.lisp`가 있을 때:\n\n```lisp\n(define (add-two a b) (+ a b))\n```\n\n`-i` 플래그를 넘겨 실행해보면, `add-two` 함수가 그대로 접근 가능하다.\n\n```bash\n$ stack run whisper-exe -- -i examples/def.lisp\n\n\u003e\u003e (add-two 1 2)\n3\n\u003e\u003e add-two\n\u003cfunction\u003e\n```\n\n이 기능은 Lisp 코드를 수정하지 않고 여러 값을 넣어 함수 호출을 해보고 싶을 때 유용하다.\n\n## `Boolean`과 조건 표현식\n\n`if` 함수를 이용해 조건 분기를 할 수 있다. 이를 위해 `boolean`타입의 값과 표현식을 추가했다.\n\n```bash\n\u003e\u003e true\ntrue\n\u003e\u003e false\nfalse\n\u003e\u003e (if true 3 5)\n3\n\u003e\u003e (if false 3 5)\n5\n```\n\n## 다양한 네이티브 함수\n\n기존에 있던 산술연산자 외에 비교연산자와 논리연산자를 구현했다.\n\n```bash\n\u003e\u003e (\u003c 3 5)\nTrue\n\u003e\u003e (= 3 5)\nFalse\n\u003e\u003e (~ true)\nFalse\n\u003e\u003e (|| true true false)\nTrue\n\u003e\u003e (\u0026\u0026 false false true)\nFalse\n\u003e\u003e (% 5 3)\n2\n\u003e\u003e (/ 5 3)\n1\n\u003e\u003e (if (\u003c 3 5) 3 5)\n3\n```\n\n## `define`을 이용한 전역변수 및 사용자 정의 함수 선언\n\n`define` 함수를 이용하면 다음과 같이 변수를 사용할 수 있다.\n\n```lisp\n(define global 3)\n\nglobal            ; 3\n(+ global global) ; 6\n```\n\n첫번째 인자가 괄호에 감싸져 있다면 함수가 된다.\n\n```lisp\n(define (add-two a b) (+ a b))\n\n(add-two 42 3)    ; 45\n```\n\n## 재귀함수 지원\n\n이 언어에는 반복문이 없다.\n\n하지만 괜찮다. 진정한 상남자 프로그래머는 반복문을 사용하지 않는다. 재귀를 사용한다!\n\n```lisp\n(define (add-range-helper start end acc)\n        (if (\u003c end start)\n            acc\n            (add-range-helper (+ 1 start) end (+ start acc))))\n\n(define (add-range start end)\n  (add-range-helper start end 0))\n\n(add-range 1 10) ; 55\n```\n\n## Functions as Values\n\n네이티브 함수와 사용자 정의 함수는 값으로 취급되어 다음과 같이 다른 함수의 인자에 전달할 수도 있다.\n\n```lisp\n(define (apply-f-to-x f x) (f x))\n\n(define (times-two x) (* x 2))\n(define (add-two x) (+ x 2))\n\n(apply-f-to-x times-two 3) ; 6\n(apply-f-to-x add-two 3)   ; 5\n```\n\n## `StateT`와 `Either` 타입을 이용한 환경 조작 및 에러 처리\n\n이번 프로젝트를 하며 가장 큰 의의는 모나드 트랜스포머(monad transformer)를 실제로 사용해봤다는 것이다. 기존에는 환경(Environment)를 `State` 모나드로 처리하고 있었다. 표현식을 평가하는 함수라면 항상 환경을 필요로 할 것이었고, 새로운 바인딩이 추가되면 환경을 수정해야 했기 때문이었다.\n\n이를 `StateT`로 바꿔야겠다고 생각했던 이유는 에러처리 때문이었다. 기존에는 에러처리를 하스켈의 `error` 함수로 했었다. 이 때문에 `error` 함수가 있는 경로로 코드가 실행되면 그냥 프로그램이 죽어버렸다. 이를 처리하기 위해 평가 결과 타입을 단순히 `Value`를 사용하기보다 `Either String Value`를 사용하면 되겠다고 생각을 했다. 그러려면 `State` 모나드의 타입이 대략 이렇게 생겨야 한다:\n\n```haskell\nnewtype State s a = State { runState :: s -\u003e Either String (a, s) }\n```\n\n참고로 원래 `State` 타입은 이렇게 생겼다.\n\n```haskell\nnewtype State s a = State { runState :: s -\u003e (a, s) }\n```\n\n근데 `s`, `a`를 적당히 조작하는 것으로는 위쪽에 있는 타입은 만들 수 없다. 여기서 [`StateT`](https://hackage.haskell.org/package/mtl-2.3.1/docs/Control-Monad-State-Lazy.html#t:StateT)가 등장한다.\n\n```haskell\nnewtype StateT s (m :: Type -\u003e Type) a = State { runState :: s -\u003e m (a, s) }\n```\n\n이를 `StateT Env (Either String) a`와 같이 사용하면 필요했던 타입을 만들 수 있고, 모나드 조작도 간편하게 할 수 있다. 아래는 scope-local 변수를 제공하는 `let` 함수의 코어 부분을 구현하는 `applyLet` 함수의 모습이다.\n\n```haskell\ntype ExecState = StateT Env (Either String)\n\napplyLet :: [Sexpr] -\u003e ExecState Value\napplyLet [decls, expr] = do\n  ogEnv \u003c- get\n  extendWithDecls decls\n  val \u003c- evalSexpr expr\n  put ogEnv\n  return val\napplyLet _ = lift . Left $ \"Let construct must include two elements. A declaration and an expression!\"\n\nextendWithDecls :: Sexpr -\u003e ExecState ()\n-- ...\n```\n\n구현부를 보면 일반 `State` 모나드처럼 `get`을 통해 상태를 접근하는 것을 확인할 수 있다. `Either String` 타입으로 감싸져 있지만 말이다. `ogEnv`와 `val`은 원래와 같이 각각 `Env`, `Value` 타입이다. 마지막에 `return`을 하면 `Right`에 감싸져서 돌려준다.\n\n반면 유효하지 않은 인자들의 경우 에러를 발생시키고 싶을 것이다. `applyLet _`의 구현부는, `Left`를 이용해 만든 `Either String Value` 타입을 `StateT` 타입의 값으로 변환시켜준다. `lift`만 사용하면 자동으로 `StateT`의 값으로 승격되며, 이 개념은 어떤 transformer를 사용해도 동일하게 적용할 수 있다.\n\n이걸 처음 도입하려고 하면서 꽤나 머릿속이 복잡했었는데, 그래도 조금씩 이해하며 그 가치를 느낄 수 있었다. 사실 아직은 조금 마법같다. 아래는 이에 대한 [하스켈 위키](https://wiki.haskell.org/Monad_Transformers_Explained)의 설명 중 하나다:\n\n\u003e Monad transformers are like onions. At first, they make you cry but then you learn to appreciate them. Like onions, they're also made of layers. Each layer is the functionality of a new monad, you lift monadic functions to get into the inner monads and you have transformerised functions to unwrap each layer.\n\n모나드 트랜스포머를 처음 봐도 눈물을 터뜨리지 않도록 조심하자.\n\n## 마무리\n\n비교적 간단한 프로젝트였지만 꽤 의미있는 경험이었다. 하스켈 코드를 작성하면서 느낀 것이지만 컴파일러를 잘 달래주면 많은 양의 버그가 사라지는 것 같다. 기억에 남는 버그는 함수 호출 시 환경을 병합할 때 `Map.union t1 t2`의 암묵적인 우선순위를 인지하지 못하고 그냥 사용해버려서 인자가 제대로 안 넘어가는 경우였는데, 하스켈에서 `trace`, `traceM` 등 순수 함수 안에서도 로그를 찍을 수 있는 짱짱한 도구들이 있어 잘 해결할 수 있었다.\n\n또 하스켈이 이론적인 기반이 탄탄하다 보니 다양한 패턴들에 대한 내장 함수들이 많은 듯했다. 나름 내 아이디어로 내가 알고 있는 함수들을 이렇게 저렇게 조합하고 나니, hls(haskell language server)가 처음 들어보는 내장함수를 내밀며 \"이 함수 하나를 써서 네가 방금 쓴 엉망 코드를 리팩토링하지 않겠니?\"라는 제안을 받아본 것이 꽤 여러번이다.\n\n마지막으로, 나는 이 포스트에 있는 기능을 추가하는 모든 과정을 영상에 담았다. 편집을 안한 정말 날것이라 다시 돌려볼 가치는 크게 없겠으나 녹화를 하며 코딩을 하니 감회가 달랐다. 어디 내놓기 부끄럽지만 유튜브에 [플레이리스트](https://www.youtube.com/playlist?list=PLZlApiQaKgfRrWRgC7Vaqck1VW5x6zHWS)를 만들어 두었다. 지금은 부끄럽기 짝이 없지만 나중에 돌려보며 웃을 수 있는 영상이 되었으면 좋겠다.\n","title":"하스켈로 간단한 Lisp 만들기 - 확장판","tags":["ko","haskell"],"date":"2023-07-02"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"20230702-haskell-lisp-extensions"},"buildId":"nGgP2WqrHtqA7AwY_62m_","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>